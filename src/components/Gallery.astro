---
import { Image } from "astro:assets";

// Import local images from your src/assets folder
import wedding1 from "../assets/images/wedding1.jpg";
import celebration from "../assets/images/celebration.jpg";
import wedding2 from "../assets/images/wedding2.jpg";
import memorial from "../assets/images/memorial.jpg";
import birthday from "../assets/images/birthday.jpg";
import wedding3 from "../assets/images/wedding3.jpg";

const images = [
  { src: wedding1, alt: "Wedding 1" },
  { src: celebration, alt: "Celebration" },
  { src: wedding2, alt: "Wedding 2" },
  { src: memorial, alt: "Memorial Service" },
  { src: birthday, alt: "Birthday Ceremony" },
  { src: wedding3, alt: "Wedding 3" },
];
---

<section id="gallery" class="gallery">
  <div class="container">
    <h2>Gallery</h2>
    <div class="gallery-grid">
      {
        images.map((image, index) => (
          <div
            class={`gallery-item ${index >= 6 ? "hidden-item" : ""}`}
            data-index={index}
            data-full={image.src.src}
          >
            <Image
              src={image.src}
              alt={image.alt}
              width={600}
              height={450}
              format="webp"
            />
          </div>
        ))
      }
    </div>

    {
      images.length > 6 && (
        <div class="show-more-container">
          <button id="show-more-btn" class="cta-button magnetic">
            Show More
          </button>
        </div>
      )
    }
  </div>
  <div id="lightbox" class="lightbox">
    <button class="close-btn">&times;</button>
    <button class="nav-btn prev-btn">&#10094;</button>
    <button class="nav-btn next-btn">&#10095;</button>
    <div class="lightbox-content">
      <div id="lightbox-loader" class="loader"></div>

      <img id="lightbox-img" src="" alt="" />
      <div class="image-counter">
        <span id="current-image">1</span> / <span id="total-images"
          >{images.length}</span
        >
      </div>
    </div>
  </div>
</section>

<script>
  let currentIndex = 0;
  let touchStartX = 0;
  let touchEndX = 0;

  const lightbox = document.getElementById("lightbox");
  const lightboxImg = document.getElementById(
    "lightbox-img",
  ) as HTMLImageElement;
  const currentImageSpan = document.getElementById("current-image");
  const galleryItems = document.querySelectorAll(".gallery-item");

  // Create an array of image data by pulling from the optimized DOM attributes
  const imageData = Array.from(galleryItems).map((item) => ({
    src: item.getAttribute("data-full"),
    alt: item.querySelector("img")?.getAttribute("alt"),
  }));

  // --- LIGHTBOX FUNCTIONS ---
  const loader = document.getElementById("lightbox-loader");

  function updateLightboxImage() {
    if (lightboxImg && currentImageSpan) {
      const data = imageData[currentIndex];

      // 1. Start loading state
      lightbox?.classList.add("loading");

      lightboxImg.src = data.src || "";
      lightboxImg.alt = data.alt || "";
      currentImageSpan.textContent = (currentIndex + 1).toString();

      // 2. Turn off loading state once image is ready
      lightboxImg.onload = () => {
        lightbox?.classList.remove("loading");
      };
    }
  }

  function openLightbox(index: number) {
    currentIndex = index;
    updateLightboxImage();
    lightbox?.classList.add("active");
    document.body.style.overflow = "hidden";
  }

  function closeLightbox() {
    lightbox?.classList.remove("active");
    document.body.style.overflow = "";
  }

  function showNext() {
    currentIndex = (currentIndex + 1) % imageData.length;
    updateLightboxImage();
  }

  function showPrev() {
    currentIndex = (currentIndex - 1 + imageData.length) % imageData.length;
    updateLightboxImage();
  }

  // --- REVEAL ON SCROLL LOGIC ---
  const revealObserver = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          entry.target.classList.add("reveal");
          revealObserver.unobserve(entry.target);
        }
      });
    },
    { threshold: 0.1 },
  );

  galleryItems.forEach((item, index) => {
    (item as HTMLElement).style.transitionDelay = `${(index % 3) * 0.1}s`;
    revealObserver.observe(item);

    // Add click listener
    item.addEventListener("click", () => openLightbox(index));
  });

  // --- EVENT LISTENERS ---
  document
    .querySelector(".close-btn")
    ?.addEventListener("click", closeLightbox);
  document.querySelector(".next-btn")?.addEventListener("click", showNext);
  document.querySelector(".prev-btn")?.addEventListener("click", showPrev);

  lightbox?.addEventListener(
    "touchstart",
    (e: any) => {
      touchStartX = e.changedTouches[0].screenX;
    },
    { passive: true },
  );

  lightbox?.addEventListener(
    "touchend",
    (e: any) => {
      touchEndX = e.changedTouches[0].screenX;
      const swipeThreshold = 50;
      if (touchEndX < touchStartX - swipeThreshold) showNext();
      if (touchEndX > touchStartX + swipeThreshold) showPrev();
    },
    { passive: true },
  );

  lightbox?.addEventListener("click", (e) => {
    if (e.target === lightbox) closeLightbox();
  });

  document.addEventListener("keydown", (e) => {
    if (!lightbox?.classList.contains("active")) return;
    if (e.key === "Escape") closeLightbox();
    if (e.key === "ArrowRight") showNext();
    if (e.key === "ArrowLeft") showPrev();
  });

  // --- SHOW MORE LOGIC ---
  const showMoreBtn = document.getElementById("show-more-btn");
  const hiddenItems = document.querySelectorAll(".hidden-item");

  if (showMoreBtn) {
    showMoreBtn.addEventListener("click", () => {
      hiddenItems.forEach((item, index) => {
        // Remove hidden class and add display/animation classes
        item.classList.remove("hidden-item");
        item.classList.add("show");

        // Apply the same stagger delay we used for the initial reveal
        (item as HTMLElement).style.transitionDelay = `${(index % 3) * 0.1}s`;

        // Trigger the reveal observer manually for these new items
        item.classList.add("reveal");
      });

      // Hide the button after all images are shown
      showMoreBtn.style.display = "none";
    });
  }
</script>
